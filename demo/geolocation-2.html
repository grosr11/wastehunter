<!DOCTYPE html>
<html>
  <head>
    <title>Geolocation - watchPosition</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      #watch {
        position: absolute;
        top: 10px;
        right: 10px;
        border: 0;
        border-radius: 4px;
        padding: 10px;
        font: bold 14px sans-serif;
        color: rgba(0, 0, 0, 0.847);
        background: #fff;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }
      .mapboxgl-popup-content {
        white-space: pre-line;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="watch">watchPosition</button>
    <script>
      const map = new mapboxgl.Map({
        accessToken:
          'pk.eyJ1Ijoid2FzdGVodW50ZXIiLCJhIjoiY2twcnkzMTZsMGpqazJ3cWt3MjVrZjhnbSJ9.KGIJ7Me0wtMYGFEc0gPkjg',
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [8, 47],
        zoom: 8,
      }).addControl(new mapboxgl.NavigationControl(), 'top-left');
      const popup = new mapboxgl.Popup({
        focusAfterOpen: false,
      });
      const marker = new mapboxgl.Marker().setPopup(popup);
      const button = document.getElementById('watch');
      let watch;

      if ('geolocation' in navigator)
        button.addEventListener('click', () => {
          if (watch) {
            navigator.geolocation.clearWatch(watch);
            watch = undefined;
            button.innerText = 'watchPosition';
            return;
          }
          watch = navigator.geolocation.watchPosition(
            ({
              coords: { latitude, longitude, accuracy, speed },
              timestamp,
            }) => {
              map.flyTo({ center: [longitude, latitude], zoom: 17, speed: 3 });
              marker.setLngLat([longitude, latitude]).addTo(map);
              popup.setText(
                `latitude: ${latitude}
                longitude: ${longitude}
                accuracy: ${accuracy} m
                speed: ${speed || 0} m/s
                time: ${new Date(timestamp).toLocaleString()}`
              );
              if (!popup.isOpen()) marker.togglePopup();
              button.innerText = 'clearWatch';
            },
            (e) => e.message && alert(e.message),
            {
              enableHighAccuracy: true,
              // maximumAge: 60e3,
              // timeout: 10e3,
            }
          );
        });
    </script>
  </body>
</html>

<!--
https://developer.mozilla.org/de/docs/Web/API/Geolocation_API

Die derzeitige Position überwachen
Wenn sich die Positionsdaten ändern (entweder über die Bewegung des Gerätes oder den Erhalt genauere Geolokationsdaten), können Sie eine Callback-Funktion erstellen, die mit der erneuerten Positionsinformation arbeitet. Dies ist über die Funktion watchPosition() möglich, welche die gleichen Eingabeparameter wie getCurrentPosition(). besitzt. Die Callback-Funktion wird mehrere Male ausgeführt, dies erlaubt dem Browser die Position aufgrund von Bewegungen oder genaueren Positionsdaten, durch das Verwenden von anderen (langsameren) Methoden, zu erneuern. Die Fehler-Callback-Funktion, welche wie auch in getCurrentPosition(),  hier optional ist, kann auch mehrfach aufgerufen werden.

Notiz: Sie können  watchPosition() auch ohne ein vorangestellten Aufruf von getCurrentPosition() nutzen.

Die Methode watchPosition() gibt eine numerische ID zurück, die für die eindeutige Identifikation des Positionsüberwachers verwendet werden kann; diese können Sie in der Methode clearWatch() nutzen, um die Positionsüberwachung zu beenden.

https://www.w3.org/TR/geolocation/
-->
